{% extends "base.yml.j2" %}

{% block services %}
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ${CONFIGS_DIR}/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      {{ port_map(4317, 4317) }}   # OTLP gRPC
      {{ port_map(4318, 4318) }}   # OTLP HTTP
      {{ port_map(8888, 8888) }}   # Collector metrics
      {{ port_map(8889, 8889) }}   # Prometheus exporter
      {{ port_map(13133, 13133) }} # Health check endpoint
    depends_on:
      - prometheus
    networks:
      - {{ NETWORK }}
    # Healthcheck removed because distroless image has no curl/wget
    
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ${CONFIGS_DIR}/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      {{ port_map(9090, 9090) }}
    networks:
      - {{ NETWORK }}
    {{ healthcheck('wget --spider -q http://localhost:9090/-/ready || exit 1') | indent(4) }}

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      {{ port_map(3000, 3000) }}
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    depends_on:
      - prometheus
    networks:
      - {{ NETWORK }}
    {{ healthcheck('curl -f http://localhost:3000/api/health') | indent(4) }}
{% endblock %}
